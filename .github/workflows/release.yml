name: Release - Build and Publish

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  version:
    name: Parse version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - id: get_version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

  build:
    name: Build for ${{ matrix.name }}
    needs: version
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            name: Windows
            archive_suffix: Windows-x64
            shell: pwsh
          - os: ubuntu-latest
            name: Linux
            archive_suffix: Linux-x64
            shell: bash
          - os: macos-latest
            name: macOS
            archive_suffix: macOS-universal
            shell: bash
    env:
      VERSION: ${{ needs.version.outputs.version }}
      ARCHIVE_SUFFIX: ${{ matrix.archive_suffix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build distributable
        shell: bash
        run: |
          python - <<'PY'
          import hashlib
          import os
          import platform
          import shutil
          from datetime import datetime
          from pathlib import Path

          from PyInstaller.__main__ import run as pyinstaller_run

          version = os.environ["VERSION"]
          suffix = os.environ["ARCHIVE_SUFFIX"]
          sep = ";" if platform.system() == "Windows" else ":"

          base_args = [
              "--name=PCAssistant",
              "--onedir",
              "--windowed",
              "--icon=src/resources/logo.png",
              "--paths=src",
              f"--add-data=src/resources{sep}resources",
              f"--add-data=config.json{sep}.",
              "--hidden-import=gui.main_window",
              "--hidden-import=gui.dashboard_tab",
              "--hidden-import=gui.cleaner_tab",
              "--hidden-import=gui.tools_tab",
              "--hidden-import=gui.disk_analyzer_tab",
              "--hidden-import=gui.optimizer_tab",
              "--hidden-import=gui.settings_tab",
              "--hidden-import=core.cleaner",
              "--hidden-import=core.duplicate_finder",
              "--hidden-import=core.optimizer",
              "--hidden-import=core.secure_delete",
              "--hidden-import=core.analyzer",
              "--hidden-import=utils.logger",
              "--hidden-import=utils.config",
              "--hidden-import=utils.admin",
              "--hidden-import=utils.scanner",
              "--hidden-import=PyQt5",
              "--hidden-import=psutil",
              "src/main.py",
          ]

          if platform.system() == "Windows":
              base_args.extend(
                  [
                      "--hidden-import=core.registry_manager",
                      "--hidden-import=core.software_manager",
                      "--hidden-import=winshell",
                      "--hidden-import=win32com",
                  ]
              )

          pyinstaller_run(base_args)

          dist_dir = Path("dist") / "PCAssistant"
          for filename in ["README.md", "GUIDA_RAPIDA.md", "config.json"]:
              src_path = Path(filename)
              if src_path.exists():
                  shutil.copy(src_path, dist_dir / src_path.name)

          (dist_dir / "logs").mkdir(exist_ok=True)
          (dist_dir / "registry_backups").mkdir(exist_ok=True)

          version_file = dist_dir / "VERSION.txt"
          version_file.write_text(
              "\n".join(
                  [
                      f"PC Assistant - Version {version}",
                      f"Build Date: {datetime.utcnow():%Y-%m-%d %H:%M:%S} UTC",
                      f"Target: {platform.system()}",
                      f"GitHub Release: v{version}",
                  ]
              )
              + "\n",
              encoding="utf-8",
          )

          archive_name = f"PCAssistant-v{version}-{suffix}"
          shutil.make_archive(archive_name, "zip", root_dir=dist_dir.parent, base_dir=dist_dir.name)

          sha256 = hashlib.sha256(Path(f"{archive_name}.zip").read_bytes()).hexdigest()
          checksum_path = f"CHECKSUMS-{suffix}.txt"
          Path(checksum_path).write_text(
              f"# SHA256\n{sha256}  {archive_name}.zip\n", encoding="utf-8"
          )

          print(f"Created {archive_name}.zip with checksum {sha256}")
          PY

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: PCAssistant-${{ matrix.archive_suffix }}
          path: |
            PCAssistant-v${{ env.VERSION }}-${{ matrix.archive_suffix }}.zip
            CHECKSUMS-${{ matrix.archive_suffix }}.txt
          retention-days: 30

  release:
    name: Publish GitHub Release
    needs: [version, build]
    runs-on: ubuntu-latest
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: builds

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            builds/**/*.zip
            builds/**/CHECKSUMS-*.txt
          body: |
            # PC Assistant v${{ needs.version.outputs.version }}
            
            ## Downloads
            - Windows: `PCAssistant-v${{ needs.version.outputs.version }}-Windows-x64.zip`
            - macOS: `PCAssistant-v${{ needs.version.outputs.version }}-macOS-universal.zip`
            - Linux: `PCAssistant-v${{ needs.version.outputs.version }}-Linux-x64.zip`
            
            Verify files with the matching `CHECKSUMS-*.txt` artifacts.
            
            ---
            
            **Full Changelog**: https://github.com/${{ github.repository }}/compare/v${{ needs.version.outputs.version }}...HEAD
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
