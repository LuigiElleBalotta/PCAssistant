name: Release - Build and Publish

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v1.2.3, etc.

permissions:
  contents: write

jobs:
  build-windows:
    name: Build Windows Executable
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Get version from tag
      id: get_version
      shell: pwsh
      run: |
        $version = "${{ github.ref_name }}" -replace '^v', ''
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
    
    - name: Build executable with PyInstaller
      run: |
        pyinstaller --name=PCAssistant `
          --onedir `
          --windowed `
          --add-data="src/resources;resources" `
          --add-data="config.json;." `
          --hidden-import=PyQt5 `
          --hidden-import=psutil `
          --hidden-import=winshell `
          --hidden-import=win32com `
          --collect-all=PyQt5 `
          src/main.py
    
    - name: Copy additional files
      shell: pwsh
      run: |
        Copy-Item README.md dist/PCAssistant/
        Copy-Item GUIDA_RAPIDA.md dist/PCAssistant/
        Copy-Item config.json dist/PCAssistant/
        New-Item -ItemType Directory -Force -Path dist/PCAssistant/logs
        New-Item -ItemType Directory -Force -Path dist/PCAssistant/registry_backups
        
        # Create version info file
        @"
        PC Assistant - Version ${{ steps.get_version.outputs.VERSION }}
        Build Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
        GitHub Release: ${{ github.ref_name }}
        "@ | Out-File -FilePath dist/PCAssistant/VERSION.txt -Encoding UTF8
    
    - name: Create ZIP archive
      shell: pwsh
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        Compress-Archive -Path dist/PCAssistant/* -DestinationPath "PCAssistant-v$version-Windows-x64.zip"
    
    - name: Calculate checksums
      shell: pwsh
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        $zipFile = "PCAssistant-v$version-Windows-x64.zip"
        $sha256 = (Get-FileHash $zipFile -Algorithm SHA256).Hash
        @"
        # Checksums for PC Assistant v$version
        
        ## SHA256
        ``````
        $sha256  $zipFile
        ``````
        "@ | Out-File -FilePath CHECKSUMS.txt -Encoding UTF8
        
        Write-Host "SHA256: $sha256"
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          PCAssistant-v${{ steps.get_version.outputs.VERSION }}-Windows-x64.zip
          CHECKSUMS.txt
        body: |
          # PC Assistant v${{ steps.get_version.outputs.VERSION }}
          
          ## üöÄ Download
          
          Download the ZIP file below, extract it, and run `PCAssistant.exe`.
          
          **No Python installation required!**
          
          ## üìã What's Included
          
          - ‚úÖ System Cleaner (temp files, browser cache, recycle bin)
          - ‚úÖ Duplicate File Finder (SHA256 hash-based)
          - ‚úÖ Software Manager (with uninstall capability)
          - ‚úÖ Startup Optimizer
          - ‚úÖ Registry Cleaner (with backup)
          - ‚úÖ Secure File Deletion (1-35 passes)
          - ‚úÖ Real-time Resource Monitoring
          
          ## üîí Security
          
          - Run as Administrator for full functionality
          - Automatic registry backup before modifications
          - Confirmation dialogs for destructive operations
          
          ## üì¶ Installation
          
          1. Download `PCAssistant-v${{ steps.get_version.outputs.VERSION }}-Windows-x64.zip`
          2. Extract the ZIP file
          3. Run `PCAssistant.exe`
          4. (Optional) Run as Administrator for full features
          
          ## üîê Checksums
          
          See `CHECKSUMS.txt` for SHA256 verification.
          
          ---
          
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/v${{ steps.get_version.outputs.VERSION }}...HEAD
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: PCAssistant-Windows-Build
        path: |
          PCAssistant-v${{ steps.get_version.outputs.VERSION }}-Windows-x64.zip
          CHECKSUMS.txt
        retention-days: 30
